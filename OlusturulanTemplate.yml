tosca_definitions_version: huaweicloud_tosca_version_1_0
description: CloudFormation Template for Phonebook Application.

Parameters: #burası node templates: olarak da değiştirilebilir.
  MyVPC: 
    description: VPC Id of my existing account
    type: HuaweiCloud.VPC.VPC
  
  Keyname: 
    description: My Keypair
    type: HuaweiCloud.ECS.KeyPair
  
  Subnets: 
    description: My subnets used by LoadBalancer
    type: list <HuaweiCloud.VPC.Subnet>

Resources:
  LBSecurityGroup:
    sg-id: 
      type: HuaweiCloud.VPC.SecurityGroup.Id
    direction:
      default: ingress
    protocol:
        default: TCP
    minPort:
      default: 80
    maxPort:
      default: 80
    VpcId: 
      get_reference: MyVPC
  
  WebServerSecurityGroup:
    sg-id:
      type: HuaweiCloud.VPC.SecurityGroup.Id
    direction:
      default: ingress
    protocol:
      default: TCP
    minPort: 
      default: 22
    maxPort: 
      default: 22
    protocol:
      default: TCP
    minPort: 
      default: 80
    maxPort: 
      default: 80
    value:
      get_attribute: [LBSecurityGroup, refID]
    VpcId: 
      get_reference: MyVPC

             #! /bin/bash
             yum update -y
             yum install python3 -y
             pip3 install flask
             pip3 install flask_mysql
             echo "${MyDBURI}" > /root/dbserver.endpoint 
             TOKEN="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"
             FOLDER="https://$TOKEN@raw.githubusercontent.com/serdarcw/phonebook_app/master"
             curl -s --create-dirs -o "/root/templates/index.html" -L "$FOLDER"/templates/index.html
             curl -s --create-dirs -o "/root/templates/add-update.html" -L "$FOLDER"/templates/add-update.html
             curl -s --create-dirs -o "/root/templates/delete.html" -L "$FOLDER"/templates/delete.html
             curl -s --create-dirs -o "/root/phonebook-app.py" -L "$FOLDER"/phonebook-app.py
             python3 /root/phonebook-app.py
            - MyDBURI: 
                get_attribute: [MyDatabaseServer.Endpoint.Address, refID]

# echo "${MyDBURI}" > /home/ec2-user/dbserver.endpoint BU KISMI 1.04.DAKİKADAN SONRA İZLE. curl comutu ile kullanılan klasörleri ECS'ye göre ayarla

# elimizdeki index.html delete.html vs dosyalarını githuba atıyoruz ki 85. satırdaki folder kısmına da
# - bu github adresimizi yazıyoruz, makina otomatik gidip bizim dosyalarımızı buradan çeksin. Burası için de 1.16'dan sonraki kısmı izle
# 61. satırdaki FOLDER kısmını alırken 1.16. dakikadan sonrasına bak !!!

 health-monitor: 
     type: HuaweiCloud.ULB.Healthmonitor 
     properties: 
       delay: 
         get_input: delay 
       timeout: 
         get_input: 3
       maxRetries: 
         get_input: 2 
       type: 
         get_input: type 
       poolId: 
         get_reference: pool 
    VpcId: 
      get_reference: MyVPC

tosca_definitions_version: huaweicloud_tosca_version_1_0
inputs:
  subnetId:
    get_reference: Subnets
node_templates:
  ulb:
    properties:
      description: ulb load balancer
      subnetId:
        get_input: subnetId
    type: HuaweiCloud.ULB.LoadBalancer